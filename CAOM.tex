\documentclass[11pt,a4paper]{ivoa}
\input tthdefs
\usepackage{todonotes}
\usepackage{caption}

\title{Common Archive Observation Model}

\ivoagroup{Data Models}

\author[https://wiki.ivoa.net/twiki/bin/view/IVOA/PatrickDowler]{Patrick Dowler}

\editor{Patrick Dowler}
\editor{S\'everin Gaudet}

\previousversion[https://www.opencadc.org/caom2/]{CAOM-2.4}

\begin{document}
\begin{abstract}
The Common Archive Observation Model (CAOM) is a metadata model that describes
astronomical data stored in archives and make that data findable and accessible.
It provides a practical model that can be implemented as the core of an astronomical
data archive and supports a wide range of data description, a wide range of 
data discovery queries, and supports key operational activities.
\end{abstract}


\section*{Acknowledgments}

???? Ack ????

\section*{Conformance-related definitions}

The words ``MUST'', ``SHALL'', ``SHOULD'', ``MAY'', ``RECOMMENDED'', and
``OPTIONAL'' (in upper or lower case) used in this document are to be
interpreted as described in IETF standard RFC2119 \citep{std:RFC2119}.

The \emph{Virtual Observatory (VO)} is a
general term for a collection of federated resources that can be used
to conduct astronomical research, education, and outreach.
The \href{https://www.ivoa.net}{International
Virtual Observatory Alliance (IVOA)} is a global
collaboration of separately funded projects to develop standards and
infrastructure that enable VO applications.


\section{Introduction}

The Common Archive Observation Model (CAOM) is a metadata model that describes
astronomical data stored in archives and make that data findable and accessible: 
the first two concepts of the FAIR principles (Findable, Accessible, Interoperable,
Reusable). 

It provides a practical model that can be implemented as the core of an astronomical
data archive and supports the description of a wide range of astronomical data and thus
a wide range of data discovery use cases.

CAOM also supports key operational activities for metadata sharing and synchronisation,
metadata validation, and loosely coupled integration with astronomical data access services.


\subsection{Role within the VO Architecture}

\begin{figure}
\centering

% As of ivoatex 1.2, the architecture diagram is generated by ivoatex in
% SVG; copy ivoatex/archdiag-full.xml to role_diagram.xml and throw out
% all lines not relevant to your standard.
% Notes don't generally need this.  If you don't copy role_diagram.xml,
% you must remove role_diagram.pdf from SOURCES in the Makefile.

\includegraphics[width=0.9\textwidth]{role_diagram.pdf}
\caption{Architecture diagram for this document}
\label{fig:archdiag}
\end{figure}

Fig.~\ref{fig:archdiag} shows the role this document plays within the
IVOA architecture \citep{2021ivoa.spec.1101D}.

The core CAOM model is specified using VODML and is intended to be a superset
of the much simpler ObsCore data model. Parts of the model make use of Vocabularies,
including UCD, DataLink semantics, and the draft product-type vocabulary (from ObsCore).
CAOM data types are tighly coupled with \verb|xtype| usage defined in DALI.

The Plane-Artifact relation in CAOM is designed to be used primarily to support a
DataLink links service: data discovery generally discovers planes and those are linked
to artifacts in a 1-to-n relationship, with the relationship described by the DataLink
semantics vocabulary.

CAOM supports concepts of public and proprietary data and metadata; access to proprietary
data and metadata can be enabled by using GMS group identifiers in the observation and
plane metadata.

\section{Use Cases}

TODO

\subsection{Describing Data}

The primary design goal of CAOM is to describe astronomical data so that 
users (astronomers) can query archives and discover data that is suitable
for a specific research goal or project. 

The metadata includes descriptive quantities to help users discover data, 
such as coverage in position, energy, and time, logical data types like 
images, spectra, and time series, and some some origin metadata like 
telescope, instrument, and proposal information.

The model also includes a structure that captures some of the important relationships 
between data products, such as different products of an observation that have had
different processing applied and new derived observations that are created by 
combining data from several other observations. CAOM also describes the way a
data product is made up of one or more physically stored components while remaining
loosely coupled with the storage system itself.

CAOM provides a transparent way to express data access rights so users can see
which data they have access to and even query for data that will soon be available.

Most importantly, new kinds of data products and areas of study sometimes require 
that the model must evolve (and new features) to better describe new data and enable
the queries that new research requires. CAOM has a well defined mechanism to support
evolution and still bring all legacy data forward with minimal effort.

\subsection{Implementation and Operations}

CAOM also supports a range of data management functions that make it implementable
and robust for large scale archive operations. The integrity of metadata that is 
created, stored, and accessed can be verified using a metadata checksum algorithm.
The metadata checksums can also be used to optimise interactions like database 
transactions and test database persistence and other forms of serialisation for
completeness and correctness.

The model is designed to support robust synchronisation of observation metadata 
between the origin and other mirror sites through modification timestamps and 
the use of metadata checksums to insure that metadata transport does not introduce
any corruption or incompleteless (details elsewhere ???).

\section{Model Overview}

\begin{figure}
\centering
\includegraphics[width=0.9\textwidth]{src/uml/CAOM1core.png}
\caption{Main CAOM classes}
\label{fig:core}
\end{figure}

\subsection{Observation}

An Observation is the result of some activity to create data. Data acquisition by a 
telescope creates a SimpleObservation, usually with one Plane describing the raw 
data. Processing that creates a new observation (e.g. by combining mutliple independent
observations into a single product) creates a DerivedObservation with a set of member
observations. 

\subsection{Plane}

A Plane is a single data product within an Observation, usually with one or more
Artifact(s) that correspond to resources (usually files) that are stored. Processing
that transforms the data in a Plane in some fashion usually creates a new Plane in
the same observation. Common processing like calibration to remove the instrument
signature change the calibration level of the plane.

\subsection{Artifact}

An Artifact holds a reference to an externally stored resource: a file, a
database object (schema or table), a collection of files (directory), etc.

\subsection{ArtifactDescription}

An ArtifactDesciption is a human-readable description of an artifact. These
descriptions are intended to be shared across many artifacts curated by a single
operator; each artifact contains an optional reference to a description. The
primary intended use of these descriptions is to populate the description field
in a DataLink links response.

\subsection{DeletedObservationEvent}

Observation(s) are designed to support metadata sharing (synchronisation of instances
from a source site to a destination site). In some cases, observations are deleted at the 
source site; in that case, the source site would create a DeletedObservationEvent with the same 
entity identifier (Entity.id) and logical identifier (Observation.uri) so that other sites can
synchronise the event and perform the correct deletion locally.

\subsection{DeletedArtifactDescriptionEvent}

ArtifactDescription(s) are designed to support metadata sharing (synchronisation of instances
from a source site to a destination site). In some cases, descriptions are deleted at the 
source site; in that case, the source site would create a DeletedArtifactDescriptionEvent with 
the same entity identifier (Entity.id) and logical identifier (ArtifactDescription.uri) so that 
other sites can synchronise the event and perform the correct deletion locally.

\subsection{Vocabularies}

CAOM uses a mixture of enumerations and vocabulary references. As it has evolved,
several concepts began as enumerations and were later converted to use a vocabulary
when it became clear that the IVOA Vocabularies process was a more appropriate way
to support the gradual evolution of set of concepts needed by the community.

\begin{center}
%\begin{figure}
\centering
\includegraphics[width=0.9\textwidth]{src/uml/CAOM3vocabularies.png}
\captionof{figure}{Enumerations and Vocabularies}
\label{fig:vocab}
%\end{figure}
\end{center}

\subsection{Entity}

The Entity concept defines the common metadata necessary to persist and validate 
instances of classes within the model. Practically, the entity classes in the 
model are related by one-to-many composition and thus indicate a limit when
implementing (e.g. in a relational mapping, each entity has to be in a separate
table and one table per entity would be the minimum number of tables required 
to persist complete instances).

\begin{center}
%\begin{figure}
\centering
\includegraphics[width=0.9\textwidth]{src/uml/CAOM4entities.png}
\captionof{figure}{CAOM Entities}
\label{fig:entity}
\%\end{figure}
\end{center}

% include external generated file so this tex doc is easy to edit
\input{generated-caom2.tex}

\section{Data Types Overview}
Some of the classes in the model are intended to be used as data types (e.g. columns
types in a database and exposed as such in a TAP service) and are inherently more reusable.
The types required by the \verb|caom2| data model are specified in the separate \verb|dt| model
below.

\begin{center}
%\begin{figure}
\centering
\includegraphics[width=0.9\textwidth]{src/uml/DataTypes.png}
\captionof{figure}{Data Types}
\label{fig:datatypes}
%\end{figure}
\end{center}

\input{generated-data-types.tex}

\appendix
\section{Changes from Previous Versions}

\subsection{Changes from OpenCADC CAOM-2.4}

\subsubsection{General Changes}
\begin{itemize}
\item change `Plane.position.bounds` to be mandatory

\item change `Plane.energy.bounds` to be mandatory

\item change `Plane.time.bounds` to be mandatory

\item change `Plane.polarization.states` to require at least 1 value; this change
means that each of the position/energy/time/polarization objects 
have one mandatory field and queries using a single is not null constraint
can be used to detect if the object is present.

\item add `ArtifactDescription` entity to support providing descriptions with links 
(eg in a DataLink output)

\item add `Artifact.descriptionID` to refer to a shared `ArtifactDescription`

\item add `Proposal.reference` as optional proposal metadata (URI to web page, paper, etc)

\item split `Entity` into a base `Entity` class with main properties and a `CaomEntity` 
suitable for having child entities (by composition); one or both could be extracted 
and re-used in other models (TBD)

\item remove Part and Chunk classes; remove the wcs package but retain Dimension2D and 
EnergyTransition as they are used in Plane
\end{itemize}

\subsubsection{Radio Support}

For radio observations, many properties such as field-of-view, spatial and spectral resolution are dependent on frequency. Modern, wideband facilities can have large frequency-dependent variation in these properties within a single observation.
\begin{itemize}
\item add `Plane.position.minBounds` (Shape) to describe variable coverage (bounds is already max bounds)

\item add `Plane.position.maxRecoverableScale` (Interval) to describe min/max scale of signal/objects in the data

\item add `Plane.energy.resolution` (double) to describe the absolute resolution (representative value, probably mean/pixel)

\item add `Plane.energy.resolutionBounds` (Interval) to describe the min/max absolute resolution when it varies across the data

\item add `Plane.time.exposureBounds` (Interval) to describe the min/max exposure time when it varies across the data

\item change `Plane.energy.restwav` to `Plane.energy.rest` so the name makes sense with different profiles (quantities and units)

\item remove `Plane.position.timeDependent` as it was only used to explain why Plane.position.bounds was null because of tracking mode

\item add `Observation.telescope.trackingMode` and refer to a non-existent IVOA vocabulary to describe the 
  tracking/pointing of the telescope during the observation; null indicates sidereal tracking (for backwards compat)

\item add `Plane.uv` (Visibility) to describe UV-plane (expect: only used when dataProductType=visibility)

\item add `Plane.uv.distance` (Interval) to describe the min and max distance in the UV plane

\item add `Plane.uv.distributionEccentricity` (double); mandatory or optional within Visibility?

\item add `Plane.uv.distributionFill` (double); mandatory or optional within Visibility?

\item change `Plane.polarization.states` to refer to a (non-existent) vocabulary (replaces PolarizationState enum) that could be extracted from WCS, ObsCore, and community usage/extensions
\end{itemize}

\subsubsection{Use of Identifiers}
\begin{itemize}
\item replace `Observation.observationID` (String) with `Observation.uri` (URI) to be the complete self contained identifier; values would be used in `DerivedObservation.members` to refer to other observations
  
\item replace `Plane.productID` (String) with `Plane.uri` (URI) to be the complete self-contained identifier; values would be used in `Plane.provenance.inputs` to refer to other planes

\item remove `Plane.creatorID` because it is essentially redundant vs Plane.uri
\end{itemize}

A `publisherID` value is strictly outside the core model because the value must be changed (generated) when CAOM metadata is synced from one publisher to a differnt publisher.

\subsubsection{Reconcile with IVOA Usage}

\begin{itemize}
\item change `Plane.dataProductType` to refer directly to the IVOA product-type vocabulary

\item change `Artifact.productType` to refer directly to the IVOA DataLink Core (semantics) vocabulary

\item change `Plane.observable.ucd` to refer directly to IVOA UCD1+

\item add `Plane.position.calibration` and refer to a non-existent IVOA vocabulary that could be extracted from the ObsCore optional section

\item add `Plane.energy.calibration` (as above)

\item add `Plane.time.calibration` (as above)

\item add `Plane.observable.calibration` (as above)

\item remove SampledInterval in favour of separate Interval and Interval[] columns in Energy, Time, CustomAxis

\item remove MultiPolygon in favour of separate Polygon and MultiShape columns; SegmentType and Vertex removed (unused)
\end{itemize}

% NOTE: IVOA recommendations must be cited from docrepo rather than ivoabib
% (REC entries there are for legacy documents only)
\bibliography{ivoatex/ivoabib,ivoatex/docrepo}


\end{document}
